<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF翻译器</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>PDF翻译器</h1>

        <div class="upload-section">
            <h2>上传PDF文件</h2>
            <input type="file" id="pdfFile" accept=".pdf">
            <button onclick="uploadPDF()">上传并解析</button>
            <div id="uploadStatus"></div>
        </div>

        <div class="control-section" id="controlSection" style="display: none;">
            <h2>翻译控制</h2>
            <div>
                <label>选择页面范围（留空翻译全部）：</label>
                <input type="text" id="pageRange" placeholder="例如: 1,2,3 或 1-5">
            </div>
            <button onclick="translatePDF()">开始翻译</button>
            <div id="translateStatus"></div>
        </div>

        <div class="result-section" id="resultSection" style="display: none;">
            <h2>翻译结果对比</h2>
            <div id="results"></div>
        </div>
    </div>

    <script>
        let currentFilepath = null;
        let totalPages = 0;

        async function uploadPDF() {
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('请选择PDF文件');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '正在上传和解析PDF...';

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentFilepath = data.filepath;
                    totalPages = data.total_pages;
                    statusDiv.innerHTML = `✓ 解析成功！共 ${totalPages} 页`;
                    document.getElementById('controlSection').style.display = 'block';
                } else {
                    statusDiv.innerHTML = `✗ 错误: ${data.error}`;
                }
            } catch (error) {
                statusDiv.innerHTML = `✗ 上传失败: ${error.message}`;
            }
        }

        async function translatePDF() {
            if (!currentFilepath) {
                alert('请先上传PDF文件');
                return;
            }

            const pageRange = document.getElementById('pageRange').value;
            let pageNumbers = [];

            if (pageRange.trim()) {
                // 解析页面范围，支持 "1,2,3" 或 "1-5" 格式
                const parts = pageRange.split(',');
                for (let part of parts) {
                    if (part.includes('-')) {
                        const [start, end] = part.split('-').map(Number);
                        for (let i = start; i <= end; i++) {
                            pageNumbers.push(i);
                        }
                    } else {
                        pageNumbers.push(Number(part.trim()));
                    }
                }
            }

            const statusDiv = document.getElementById('translateStatus');
            statusDiv.innerHTML = '正在翻译，请稍候...';

            try {
                const response = await fetch('/translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filepath: currentFilepath,
                        page_numbers: pageNumbers.length > 0 ? pageNumbers : null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = `✓ 翻译完成！共翻译 ${data.total_pages} 页`;
                    displayResults(data.translated_pages);
                } else {
                    statusDiv.innerHTML = `✗ 翻译失败: ${data.error}`;
                }
            } catch (error) {
                statusDiv.innerHTML = `✗ 翻译失败: ${error.message}`;
            }
        }

        function displayResults(pages) {
            const resultSection = document.getElementById('resultSection');
            const resultsDiv = document.getElementById('results');

            resultSection.style.display = 'block';
            resultsDiv.innerHTML = '';

            pages.forEach(page => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page-result';

                pageDiv.innerHTML = `
                    <h3>第 ${page.page} 页</h3>
                    <div class="comparison">
                        <div class="original">
                            <h4>原文</h4>
                            <pre>${escapeHtml(page.original)}</pre>
                        </div>
                        <div class="translated">
                            <h4>译文</h4>
                            <pre>${escapeHtml(page.translated)}</pre>
                        </div>
                    </div>
                `;

                resultsDiv.appendChild(pageDiv);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
